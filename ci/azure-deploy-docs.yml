- job: documentation
  displayName: 'Deploy API Documentation'
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - template: azure-install-rust.yml
    parameters:
      platform: ${{parameters.name}}
      rust_version: stable
  - script: |
      cargo doc --all --no-deps
      cp -R * target/doc/'$(Build.BinariesDirectory)'
    displayName: 'Generate Documentation'
  - script: |
      set -e

      ls -la
      git init
      git config user.name 'Deployment Bot (from Azure Pipelines)'
      git config user.email 'deploy@tower-rs.com'
      git branch gh-pages origin/gh-pages
      git checkout gh-pages
      git add .
      git commit -m 'Deploy Tower API documentation'
    workingDirectory: '$(Build.BinariesDirectory)'
    displayName: 'Deploy Documentation'

    #   - task: archivefiles@2
    #     displayName: 'Archive Documentation'
    #     inputs:
    #       rootFolderOrFile: '$(Build.BinariesDirectory)'
    #       includeRootFolder: false
    #       archiveFile: '$(Build.ArtifactStagingDirectory)/api-documentation.zip'
    #   - task: publishbuildartifacts@1
    #     displayName: 'Upload Documentation Artifact'
    #     inputs:
    #       pathToPublish: '$(Build.ArtifactStagingDirectory)'
    #       artifactName: 'docs'
    #   - script: |
    #       git remote -v
    #       echo 'machine github.com' > ~/.netrc
    #       echo 'login $(GITHUB_USERNAME)' >> ~/.netrc
    #       echo 'password $(GITHUB_PAT)' >> ~/.netrc
    #       git push origin gh-pages
    #     displayName: 'Publish Documentation'
    #     condition: eq(variables['Build.Reason'], 'IndividualCI')
